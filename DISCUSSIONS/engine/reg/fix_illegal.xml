<!-- 
  This software was produced by NIST, an agency of the
  U.S. government, and by statute is not subject to copyright in the
  United States.  Recipients of this software assume all
  responsibilities associated with its operation, modification and
  maintenance. However, to facilitate maintenance we ask that before
  distributing modified versions of this software, you first contact
  the authors at oof_manager@nist.gov.
-->

<para>
  <classname>FixIllegal</classname> is a <xref
  linkend="RegisteredClass-SkeletonModifier"/> that fixes <link
  linkend="Section-Concepts-Skeleton-Illegality">illegal</link>
  &skel; &elems;.
</para>
<para>
  Excluding paranormal alien interventions, illegal elements are only
  generated by moving &nodes; manually with the <link
  linkend="Section-Graphics-MoveNodes">Move Nodes toolbox</link>.
  Many algorithms used by &oof2; (including solving finite element
  equations and some &skel; modifiers) assume that &elems; are legal,
  so it prohibits almost all operations if illegal &elems; exist.
</para>
<para>
  <classname>FixIllegal</classname> fixes an &elem; by moving one or
  more of its &nodes; to the average position of its neighboring &nodes; 
  In many cases, it is sufficient to fix an &elem; by applying this
  smoothing procedure to the offending &nodes;, namely those &nodes; located
  at corners that subtend interior angles greater than
  180&deg; or less than 0&deg; (for quadrilaterals, illegal elements
  include those that have non-convex geometries). However, this
  smoothing procedure may not work when the corner angle is very close
  to zero. In this case, the &nodes; at other corners should be moved as well.
  Each move is ultimately accepted or rejected solely by
  whether or not it reduces the number of illegal &elems; in the
  vicinity of the &node;.
</para>
<para>
  <xref linkend="Figure-illegal"/> illustrates the process of creating
  and fixing illegal &elems;.  Notice that in (c) the &nodes; are not
  exactly in their initial positions.  This is because
  <classname>FixIllegal</classname> is a brutal technique: it pays no
  attention to &elem; <link
  linkend="Section-Concepts-Skeleton-Homogeneity">homogeneity</link>
  or <link linkend="Section-Concepts-Skeleton-Shape_Energy">shape
  energy</link> and does not attempt to optimize the positions of the
  &nodes; that it moves.  If it's necessary to return them to a
  particular legal configuration, it's better to <link
  linkend="MenuItem-OOF.Skeleton.Undo">undo the modification</link>
  that created the illegal &elems;.
</para>
  
<figure id="Figure-illegal">
  <title>Fixing Illegal Elements</title>
  <mediaobject>
    <imageobject>
	  <imagedata fileref="FIGURES/fixillegal.png" format="PNG"/>
    </imageobject>
    <caption>
      <para>
        (a) A section of a &skel;.  The highlighted &nodes; will be
        moved as shown by the arrows to make the highlighted &elems;
        illegal.
      </para>
      <para>
        (b) The &nodes; have been moved and the illegal &elems; are
        automatically highlighted in red.  For comparison, the
        original &elem; edges are displayed in pale green.  The
        triangle has been inverted and the quadrilateral is no longer
        convex.
      </para>
      <para>
        (c) After applying <classname>FixIllegal</classname>, the
        &elems; are legal again, but are not exactly where they
        started in (a).
      </para>
    </caption>
  </mediaobject>
</figure>
<para>
  On one pass through the &skel;, <classname>FixIllegal</classname>
  attempts to move each &node; of the troublesome elements once,
  choosing the &elems; and &nodes; in a random order. It may not be
  successful on the first pass, so it repeats the process until there
  are no more illegal &elems;.  If any one pass through the &skel;
  fails to fix any &elems;, or if it fails to remove all the illegal
  &elems; after a fixed number of iterations,<footnote>
  <para>Hard-wired to 222, because the exact number shouldn't matter
  too much.</para> </footnote> it will quit trying and notify the
  user.
</para>

  <!-- Keep this comment at the end of the file
  Local variables:
  sgml-omittag:t
  sgml-shorttag:t 
  sgml-namecase-general:nil
  sgml-minimize-attributes:nil
  sgml-always-quote-attributes:t
  sgml-indent-step:2
  sgml-indent-data:t
  sgml-parent-document:("../../man_oof2.xml" "book" "chapter" "refentry" "refsect1")
  sgml-exposed-tags:nil
  sgml-local-ecat-files:nil
  End:
  -->
